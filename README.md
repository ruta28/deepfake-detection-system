
# Deepfake Detection System

This project implements a deep learning system for detecting **deepfake images** using **PyTorch**.
It leverages a **pre-trained EfficientNet** model combined with an **LSTM** layer for temporal feature analysis and includes explainability through **Grad-CAM** heatmaps.
The system is designed to handle **imbalanced datasets** and fine-tuned to improve recall on challenging fake samples.

---

## Key Features

* **Deepfake Detection:** Classifies images as either **REAL** or **FAKE**.
* **High Performance:** Achieves strong recall for fake images after addressing data imbalance.
* **Explainability:** Generates **Grad-CAM heatmaps** to visualize which image regions influenced predictions.
* **Transfer Learning:** Utilizes a pre-trained **EfficientNet-B0** backbone for robust feature extraction.
* **Data Handling:** Supports **large datasets (Git LFS)** and **imbalanced class oversampling**.

---

## Project Structure

```
├── data/                    # Dataset (requires Git LFS)
│   ├── train/
│   │   ├── real/
│   │   └── fake/
│   └── val/
│       ├── real/
│       └── fake/
├── src/                     # Source code
│   ├── datasets/            # Dataset logic (deepfake_dataset2.py)
│   ├── explainability/      # Grad-CAM implementation (gradcam.py)
│   ├── models/              # Model architectures (cnn_lstm.py, efficientnet_lstm.py)
│   ├── evaluate.py          # Evaluate model performance
│   ├── finetune.py          # Fine-tune on failure cases
│   ├── main.py              # Predict single image with Grad-CAM
│   └── train.py             # Train the model
├── .gitattributes           # Git LFS configuration
├── .gitignore
├── best_model.pth           # Model weights after training
├── best_model_finetuned.pth # Final fine-tuned model
├── failures.json            # Failed predictions (generated by evaluate.py)
├── requirements.txt         # Dependencies
└── README.md                # This file
```

---

## Setup Instructions

### 1. Prerequisites

* Python **3.9+**
* [Git](https://git-scm.com/downloads)
* [Git LFS](https://git-lfs.com) (install after Git)

### 2. Clone the Repository

```bash
git clone https://<YOUR_USERNAME>:<YOUR_PAT>@github.com/ruta28/deepfake-detection-system.git
cd deepfake-detection-system
```

Download the large files tracked by Git LFS:

```bash
git lfs pull
```

> *Note: Requires authentication (Personal Access Token) if data size exceeds GitHub’s free tier.*

---

### 3. Set Up a Virtual Environment

```bash
python -m venv .venv
```

Activate the environment:

* **Windows (PowerShell):**

  ```bash
  .\.venv\Scripts\activate
  ```
* **macOS/Linux:**

  ```bash
  source .venv/bin/activate
  ```

---

### 4. Install Dependencies

```bash
pip install -r requirements.txt
```

---

## Usage

### 1. Training (Recommended: GPU / Google Colab)

Ensure your dataset is in the correct structure under `data/train` and `data/val`.

```bash
python -m src.train
```

This script will:

* Train the model
* Perform early stopping
* Save best weights to `best_model.pth`

---

### 2. Evaluate Model Performance

After training:

```bash
python -m src.evaluate
```

This prints:

* Classification report
* Confusion matrix
* Saves incorrect predictions to `failures.json`

---

### 3. Fine-Tune on Failures *(Optional but Recommended)*

If `failures.json` exists, fine-tune on those examples:

```bash
python -m src.finetune
```

Output:

```
best_model_finetuned.pth
```

---

### 4. Predict a Single Image (with Grad-CAM)

Predict and generate a Grad-CAM heatmap:

```bash
python -m src.main --frame path/to/image.jpg --weights best_model_finetuned.pth --out output_dir
```

**Example:**

```bash
python -m src.main --frame data/val/fake/sample.jpg --weights best_model_finetuned.pth --out evidence_sample
```

**Output:**

```json
{
  "decision": "FAKE",
  "probability": 0.9999,
  "heatmap": "evidence_sample/gradcam.png"
}
```

---

## Performance

After training the **EfficientNet-LSTM** model with oversampling, data augmentation, and fine-tuning,
the system achieves **high recall for fake images** while maintaining **strong precision**.

Run `src/evaluate.py` with `best_model_finetuned.pth` to view metrics.

---

## Explainability (Grad-CAM)

The Grad-CAM visualization highlights **image regions** that influenced the model’s decision most.

* **Red/Yellow:** High importance areas
* **Blue:** Low importance

The heatmap is automatically saved as:

```
<output_dir>/gradcam.png
```

---

## Future Work

* Integrate **video processing** for frame-by-frame detection
* Experiment with **Vision Transformers (ViT)** or other backbones
* Explore **GAN fingerprinting** and **frequency-based features**

---
